name: Build and Deploy API to CentOS

# 触发器：当有代码 push 到 main 分支时自动运行
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build-and-push-docker-image:
    # 运行环境：使用最新的 ubuntu 系统
    runs-on: ubuntu-latest

    steps:
    # 步骤 1: 检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 步骤 2: 登录到 Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 步骤 3: 设置 Docker Buildx (一个增强的构建工具)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 检查并安装 .NET 10 SDK（如未安装）
    - name: Install .NET 10 SDK with dotnet-install.sh if not present
      run: |
        if ! dotnet --list-sdks | grep -q '^10\.'; then
          curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --version 10.0.100 --install-dir $HOME/.dotnet
          echo "$HOME/.dotnet" >> $GITHUB_PATH
          export DOTNET_ROOT=$HOME/.dotnet
        else
          echo ".NET 10 SDK already installed."
        fi

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '10.0.x'

    # 步骤 3.6: 还原依赖
    - name: Restore dependencies
      run: dotnet restore ./src/cocity.sln

    # 步骤 3.7: 运行单元测试
    - name: Run tests
      run: dotnet test ./src/cocity.sln --no-restore --verbosity normal

    # 步骤 4: 构建 Docker镜像并推送到Dockerhub
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./src
        file: ./src/Dockerfile
        push: ${{ github.ref == 'refs/heads/main' }} # 推送到仓库
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/cocity-api:latest # 修改为你的 Docker Hub 仓库名

  deploy-to-server:
    # 依赖：需要等上一个 job (build-and-push-docker-image) 成功后才运行
    needs: build-and-push-docker-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    # 步骤 1: SSH 连接到服务器并执行部署命令
    - name: Deploy to CentOS Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }} 
        script: |
          # 脚本将在你的 CentOS 服务器上执行
          # 拉取最新的 Docker 镜像
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cocity-api:latest

          # 停止并删除旧的容器 (如果存在)
          # 使用 || true 是为了防止在第一次部署时因为找不到容器而报错
          docker stop cocity-api-container || true
          docker rm cocity-api-container || true

          # 运行新的容器
          docker run -d \
            --name cocity-api-container \
            -p 9000:8080 \
            --network elk-stack_elk \
            --restart always \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e Serilog__WriteTo__1__Args__password="${{ secrets.ELASTICSEARCH_PASSWORD }}" \
            -e LocalhostToken="${{ secrets.LOCALHOST_TOKEN }}" \
            -e AllowedOrigins="${{ vars.ALLOWED_ORIGINS }}" \
            -e Jwt__SecretKey="${{ secrets.JWT_SECRETKEY }}" \
            -e Jwt__Issuer="${{ vars.JWT_ISSUER }}" \
            -e Jwt__Audience="${{ vars.JWT_AUDIENCE }}" \
            -e ConnectionStrings__DefaultConnection="${{ vars.DB_CONNECTION }}" \
            -e Serilog__WriteTo__1__Args__nodes__0="${{ vars.ELASTICSEARCH_URL }}" \
            ${{ secrets.DOCKERHUB_USERNAME }}/cocity-api:latest
